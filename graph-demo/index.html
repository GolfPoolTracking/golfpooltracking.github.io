<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microsoft Graph Excel Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
  <h1 class="mb-4">Golf Pool Results (Live)</h1>

  <button id="signin" class="btn btn-primary mb-3">Sign in with Microsoft</button>

  <div id="results-container" class="table-responsive">
    <p class="text-muted">Sign in to load data from Excel...</p>
  </div>

  <!-- MSAL.js (Microsoft Authentication Library) -->
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>

  <script>
  // ======== CONFIGURE THESE =========
  const clientId    = "af978ce8-62ec-47dd-8d03-a8ef61ed78b1";  // Azure App Registration
  const redirectUri = window.location.origin + "/graph-demo/auth.html";
  const fileId      = "29A99D65AA1785D4!s4fc07b975524497da651a46e4de1b0fe"; // OneDrive file ID
  const rangeName   = "WEBSITE_RESULTS"; // Named range in Excel (case-sensitive)
  // ===================================

  const msalConfig = {
      auth: { clientId: clientId, redirectUri: redirectUri }
  };
  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const loginRequest = { scopes: ["Files.Read"] };

  document.getElementById("signin").onclick = async () => {
      try {
          // Sign in
          const loginResp = await msalInstance.loginPopup(loginRequest);
          const account = loginResp.account;
          msalInstance.setActiveAccount(account);

          // Get access token
          const tokenResp = await msalInstance.acquireTokenSilent({
              ...loginRequest, account
          }).catch(() => msalInstance.acquireTokenPopup(loginRequest));

          const token = tokenResp.accessToken;

          // Build Graph URL using file ID
          const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/names('${encodeURIComponent(rangeName)}')/range`;

          // Fetch data from Graph
          const resp = await fetch(url, {
              headers: { "Authorization": `Bearer ${token}` }
          });

          if (!resp.ok) {
              throw new Error(`Graph API error: ${resp.status}`);
          }

          const data = await resp.json();
          renderTable(data.values);

      } catch (err) {
          console.error("Error loading Excel data:", err);
          document.getElementById("results-container").innerHTML =
              `<div class="alert alert-danger">Failed to load data: ${err.message}</div>`;
      }
  };

  function renderTable(values) {
      const table = document.createElement("table");
      table.className = "table table-striped table-bordered";
      values.forEach((row, i) => {
          const tr = document.createElement("tr");
          row.forEach(cell => {
              const tag = i === 0 ? "th" : "td";
              const td = document.createElement(tag);
              td.textContent = cell;
              tr.appendChild(td);
          });
          table.appendChild(tr);
      });
      const container = document.getElementById("results-container");
      container.innerHTML = "";
      container.appendChild(table);
  }
  </script>
</body>
</html>
