<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Golf Pool Results (Graph API Demo)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
  <h1 class="mb-4">Golf Pool Results</h1>

  <!-- Sign in button -->
  <button id="signin" class="btn btn-primary mb-3">Sign in with Microsoft</button>

  <!-- Container for results -->
  <div id="results-container" class="table-responsive">
    <p class="text-muted">Click "Sign in with Microsoft" to load Excel data.</p>
  </div>

  <!-- MSAL.js -->
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>

  <script>
  // ======== CONFIGURE THESE =========
  const clientId   = "af978ce8-62ec-47dd-8d03-a8ef61ed78b1"; // Azure App Registration
  const fileId     = "29A99D65AA1785D4!s4fc07b975524497da651a46e4de1b0fe"; // Excel file ID
  const rangeName  = "WEBSITE_RESULTS"; // Excel named range
  // ===================================

  const msalConfig = {
    auth: {
      clientId: clientId,
      redirectUri: window.location.origin // must match Azure AD app
    }
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const loginRequest = { scopes: ["Files.Read"] };

  let account = null; // currently logged-in account

  // Sign in & fetch data
  document.getElementById("signin").onclick = async () => {
    try {
      const loginResp = await msalInstance.loginPopup(loginRequest);
      account = loginResp.account;
      await fetchExcelData(); // fetch immediately after login
    } catch (err) {
      console.error("Login error:", err);
      document.getElementById("results-container").innerHTML =
        `<div class="alert alert-danger">Login error: ${err.message}</div>`;
    }
  };

  // Fetch Excel data with automatic token refresh
  async function fetchExcelData() {
    try {
      if (!account) throw new Error("User not logged in");

      // Try silent token acquisition first
      const tokenResp = await msalInstance.acquireTokenSilent({
        ...loginRequest,
        account: account
      }).catch(async (silentErr) => {
        // fallback to popup if silent fails (expired session, etc.)
        console.warn("Silent token failed, showing popup:", silentErr);
        return msalInstance.acquireTokenPopup(loginRequest);
      });

      const token = tokenResp.accessToken;

      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/names('${rangeName}')/range`;
      const resp = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(`Graph API error ${resp.status}: ${errorText}`);
      }

      const data = await resp.json();
      renderTable(data.values);

    } catch (err) {
      console.error("Fetch error:", err);
      document.getElementById("results-container").innerHTML =
        `<div class="alert alert-danger">Error fetching data: ${err.message}</div>`;
    }
  }

  // Render Excel range as Bootstrap table
  function renderTable(values) {
    if (!values || values.length === 0) {
      document.getElementById("results-container").innerHTML =
        `<p class="text-muted">No data found in the named range.</p>`;
      return;
    }

    const table = document.createElement("table");
    table.className = "table table-striped table-bordered";

    values.forEach((row, i) => {
      const tr = document.createElement("tr");
      row.forEach(cell => {
        const tag = i === 0 ? "th" : "td";
        const td = document.createElement(tag);
        td.textContent = cell ?? "";
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });

    const container = document.getElementById("results-container");
    container.innerHTML = "";
    container.appendChild(table);
  }

  // Optional: automatically fetch data if user is already logged in
  window.addEventListener("load", async () => {
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
      account = accounts[0];
      await fetchExcelData();
    }
  });
  </script>
</body>
</html>
