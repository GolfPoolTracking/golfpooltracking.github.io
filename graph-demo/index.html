<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Golf Pool Results (Graph API Demo)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
  <h1 class="mb-4">Golf Pool Results</h1>

  <!-- Sign in button -->
  <button id="signin" class="btn btn-primary mb-3">Sign in with Microsoft</button>

  <!-- Container for results -->
  <div id="results-container" class="table-responsive">
    <p class="text-muted">Click "Sign in with Microsoft" to load Excel data.</p>
  </div>

  <!-- Microsoft Authentication Library -->
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>

  <script>
  // ======== CONFIGURE THESE =========
  const clientId = "af978ce8-62ec-47dd-8d03-a8ef61ed78b1"; // Azure App Registration
  const fileId   = "29A99D65AA1785D4!s4fc07b975524497da651a46e4de1b0fe"; // Excel file ID
  const rangeName = "Website_Results"; // Exact name of the Excel named range
  // ===================================

  const msalConfig = {
    auth: {
      clientId: clientId,
      // Redirect back to the same page after popup closes
      redirectUri: window.location.origin + "/graph-demo/"
    }
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  const loginRequest = { scopes: ["Files.Read"] };

  // Handle Sign In
  document.getElementById("signin").onclick = async () => {
    try {
      // Prompt user to log in
      const loginResp = await msalInstance.loginPopup(loginRequest);

      // Get an access token silently if possible, else popup
      const tokenResp = await msalInstance.acquireTokenSilent({
        ...loginRequest,
        account: loginResp.account
      }).catch(() => msalInstance.acquireTokenPopup(loginRequest));

      const token = tokenResp.accessToken;

      // Microsoft Graph API endpoint for Excel named range
      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/names('${rangeName}')/range`;

      console.log("Fetching data from:", url);

      const resp = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!resp.ok) {
        const errorText = await resp.text();
        console.error("Graph API error:", resp.status, errorText);
        document.getElementById("results-container").innerHTML =
          `<div class="alert alert-danger">Error ${resp.status}: ${errorText}</div>`;
        return;
      }

      const data = await resp.json();
      console.log("Graph response:", data);
      renderTable(data.values);

    } catch (err) {
      console.error("Login/Fetch error:", err);
      document.getElementById("results-container").innerHTML =
        `<div class="alert alert-danger">Error: ${err.message}</div>`;
    }
  };

  // Render Excel range as a Bootstrap table
  function renderTable(values) {
    const table = document.createElement("table");
    table.className = "table table-striped table-bordered";

    values.forEach((row, i) => {
      const tr = document.createElement("tr");
      row.forEach(cell => {
        const tag = i === 0 ? "th" : "td";
        const td = document.createElement(tag);
        td.textContent = cell;
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });

    const container = document.getElementById("results-container");
    container.innerHTML = "";
    container.appendChild(table);
  }
  </script>
</body>
</html>
