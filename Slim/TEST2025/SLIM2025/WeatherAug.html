<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="../style.css">
    

<title>SLIM 2025 - Weather Forecast</title>
<style>
body { font-family: Arial,sans-serif; background:#f4f7f9; margin:0; padding:0; color:#333;}
header {background:#004080; color:#fff; padding:1rem; text-align:center;}
header h1{margin:0;}
.timestamp{font-size:0.9rem;color:#ddd;}
.day-group{margin:1.5rem; padding:1rem; background:#fff; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.day-title{font-size:1.3rem; margin-bottom:0.5rem; border-bottom:2px solid #eee; padding-bottom:0.5rem; font-weight:bold;}
.forecast-cards{display:flex; flex-wrap:wrap; gap:0.5rem;}
.card{flex:0 0 90px; background:#fdfdfd; border:1px solid #ddd; border-radius:10px; padding:0.5rem; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);}
.time{font-weight:bold; margin-bottom:0.2rem;}
.temp{font-size:1.1rem; margin:0.2rem 0;}
.wind{font-size:0.8rem; margin:0.2rem 0; display:flex; align-items:center; justify-content:center; gap:0.2rem;}
.wind-arrow{display:inline-block; width:12px; height:12px; border:solid #333; border-width:0 2px 2px 0; padding:1px;}
.rain{font-size:0.8rem; margin:0.2rem 0;}
img.weather-icon{width:50px; height:50px;}
</style>
</head>
<body>
<div class=\"container\">
<header>
<h1>SLIM 2025 - Weather Forecast</h1>
<div class="timestamp" id="timestamp"></div>
</header>
<div id="forecast"></div>

<script>
// Convert degrees to compass
function degToCompass(num){
  const val=Math.floor((num/22.5)+0.5);
  const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[val%16];
}

// Get local hour from ISO timestamp
function getLocalHour(time){ return new Date(time).getHours(); }

// Check if a local file exists (synchronous)
function fileExists(path){
  try {
    const xhr = new XMLHttpRequest();
    xhr.open('HEAD', path, false);
    xhr.send();
    return xhr.status != 404;
  } catch(e){ return false; }
}

// Get the appropriate icon
function getIconUrl(symbol,hour){
  if(!symbol) return "../../forecast_icons/00.png";
  let num = String(symbol).padStart(2,"0");
  const suffix = (hour>=7 && hour<=19) ? "d" : "n";
  const variants = [`${num}${suffix}.png`, `${num}.png`];
  for(const v of variants){
    const path = `../../forecast_icons/${v}`;
    if(fileExists(path)) return path;
  }
  return "../../forecast_icons/00.png";
}

async function loadForecast(){
  try{
    const res = await fetch("../../forecast_data/forecast.json");
    if(!res.ok) throw new Error("Failed to load forecast");
    const data = await res.json();

    document.getElementById("timestamp").textContent = "Updated: "+new Date(data.timestamp).toLocaleString();

    const container = document.getElementById("forecast");
    container.innerHTML="";

    // Group forecasts by group name
    const grouped = {};
    for(const f of data.forecasts){
      if(!grouped[f.group]) grouped[f.group]=[];
      grouped[f.group].push(f);
    }

    for(const [group, forecasts] of Object.entries(grouped)){
      // Sort by time
      forecasts.sort((a,b)=>new Date(a.time)-new Date(b.time));

      // Remove duplicates (just in case)
      const seen = new Set();
      const unique = [];
      forecasts.forEach(f=>{
        if(!seen.has(f.time)){
          seen.add(f.time);
          unique.push(f);
        }
      });

      const dayDiv = document.createElement("div");
      dayDiv.className="day-group";
      const title = document.createElement("div");
      title.className="day-title";
      title.textContent = group.replace("_"," ");
      dayDiv.appendChild(title);

      const cards = document.createElement("div");
      cards.className="forecast-cards";

      unique.forEach(f=>{
        const card = document.createElement("div");
        card.className="card";

        const hour = getLocalHour(f.time);

        const timeDiv = document.createElement("div");
        timeDiv.className="time";
        timeDiv.textContent = new Date(f.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

        const iconImg = document.createElement("img");
        iconImg.className="weather-icon";
        iconImg.src = getIconUrl(f.WeatherSymbol,hour);
        iconImg.alt="Weather";

        const tempDiv = document.createElement("div");
        tempDiv.className="temp";
        tempDiv.textContent = (f.Temperature ?? "-")+"Â°C";

        const windDiv = document.createElement("div");
        windDiv.className="wind";
        if(f.WindDirection!=null && f.WindSpeed!=null){
          const dir = degToCompass(f.WindDirection);
          const arrow = document.createElement("span");
          arrow.className="wind-arrow";
          arrow.style.transform=`rotate(${f.WindDirection}deg)`;
          windDiv.textContent = `${Math.round(f.WindSpeed)} km/h ${dir} `;
          windDiv.appendChild(arrow);
        } else { windDiv.textContent="Wind: -"; }

        const rainDiv = document.createElement("div");
        rainDiv.className="rain";
        rainDiv.textContent = `Rain: ${f.Rainfall ?? 0} mm`;

        card.appendChild(timeDiv);
        card.appendChild(iconImg);
        card.appendChild(tempDiv);
        card.appendChild(windDiv);
        card.appendChild(rainDiv);

        cards.appendChild(card);
      });

      dayDiv.appendChild(cards);
      container.appendChild(dayDiv);
    }

  } catch(e){
    document.getElementById("forecast").textContent="Error loading forecast.";
    console.error(e);
  }
}

loadForecast();
</script>
</div>
</body>
</html>
