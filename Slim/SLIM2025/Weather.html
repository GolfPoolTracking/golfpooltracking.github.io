<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SLIM 2025 - Weather Forecast</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  h1 { text-align: center; }
  .timestamp { text-align: center; font-size: 0.9em; color: #666; margin-bottom: 20px; }
  .forecast-group { margin-bottom: 40px; }
  h2 { margin-top: 30px; }
  .cards { display: flex; flex-wrap: wrap; gap: 15px; }
  .card { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); width: 140px; text-align: center; }
  .card img { width: 50px; height: 50px; }
  .wind { font-size: 14px; margin-top: 5px; }
</style>
</head>
<body>
<h1>SLIM 2025 - Weather Forecast</h1>
<div id="timestamp" class="timestamp"></div>
<div id="forecast"></div>

<script>
function degToCompass(num) {
  if (num === undefined) return "";
  const val = Math.floor((num / 22.5) + 0.5);
  const arr = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return arr[val % 16];
}

function degToArrow(num) {
  if (num === undefined) return "";
  const arrows = ["↑","↗","→","↘","↓","↙","←","↖"];
  const val = Math.floor((num / 45) + 0.5);
  return arrows[val % 8];
}

function getIconUrl(symbolNumber, hour) {
  if (!symbolNumber) return { url: "", fallback: "" };
  const numStr = String(symbolNumber).padStart(2,'0');
  let suffix = "";
  if (hour !== undefined) {
    suffix = (hour >= 6 && hour < 18) ? "d" : "n"; // day 6–17
  }
  const urlWithSuffix = `https://www.met.ie/cms/assets/uploads/2018/01/${numStr}${suffix}.png`;
  const urlNoSuffix = `https://www.met.ie/cms/assets/uploads/2018/01/${numStr}.png`;
  return { url: urlWithSuffix, fallback: urlNoSuffix };
}

async function loadForecast() {
  try {
    const resp = await fetch("../forecast_data/forecast_sep.json");
    if (!resp.ok) throw new Error("Fetch failed");
    const data = await resp.json();

    document.getElementById("timestamp").textContent =
      "Last updated: " + new Date(data.timestamp).toLocaleString();

    const grouped = {};
    data.forecasts.forEach(f => {
      if (!grouped[f.group]) grouped[f.group] = [];
      grouped[f.group].push(f);
    });

    const forecastDiv = document.getElementById("forecast");
    forecastDiv.innerHTML = "";

    const groupNames = {
      "Portsalon_28Aug": "Thursday 28 Aug - Portsalon (11am–7pm)",
      "Downings_29Aug": "Friday 29 Aug - Downings (11am–7pm)",
      "Downings_30Aug": "Saturday 30 Aug - Downings (11am–7pm)",
      "Downings_31Aug": "Sunday 31 Aug - Downings (7am–3pm)"
    };

    for (const [label, entries] of Object.entries(grouped)) {
      const gDiv = document.createElement("div");
      gDiv.className = "forecast-group";

      const title = document.createElement("h2");
      title.textContent = groupNames[label] || label;
      gDiv.appendChild(title);

      const cardsDiv = document.createElement("div");
      cardsDiv.className = "cards";

      entries.forEach(e => {
        const card = document.createElement("div");
        card.className = "card";

        const time = new Date(e.time);
        const hour = time.getHours();
        const timeStr = time.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

        const icon = getIconUrl(e.WeatherSymbol3, hour);
        const iconTag = icon.url 
          ? `<img src="${icon.url}" alt="icon" onerror="this.onerror=null;this.src='${icon.fallback}';">` 
          : '';

        const windDir = degToCompass(e.WindDirection);
        const windArrow = degToArrow(e.WindDirection);
        const wind = (e.WindSpeed !== undefined) ? `${Math.round(e.WindSpeed)} km/h ${windDir} ${windArrow}` : "";

        const rainText = e.Rainfall !== undefined ? `Rain: ${e.Rainfall} mm` : '';

        card.innerHTML = `
          <h3>${timeStr}</h3>
          <div>${e.Temperature !== undefined ? e.Temperature + '°C' : ''}</div>
          <div>${iconTag}</div>
          <div>${rainText}</div>
          <div class="wind">${wind}</div>
        `;
        cardsDiv.appendChild(card);
      });

      gDiv.appendChild(cardsDiv);
      forecastDiv.appendChild(gDiv);
    }
  } catch(err) {
    document.getElementById("forecast").innerHTML = "<p>Error loading forecast.</p>";
    console.error(err);
  }
}

loadForecast();
</script>
</body>
</html>
