<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Golf Trip Weather Forecast</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; color: #333; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    .day-group { margin-top: 30px; }
    .day-title { font-size: 1.3em; font-weight: bold; margin-bottom: 12px; color: #1a4d8f; }
    .forecast { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; }
    .time { font-weight: bold; margin-bottom: 8px; font-size: 1.1em; }
    .icon { font-size: 2em; margin-bottom: 6px; display: block; }
    .line { margin: 4px 0; }
  </style>
</head>
<body>
<h1>Golf Trip Weather Forecast</h1>
<div id="forecast">Loading forecast...</div>

<script>
async function loadForecast() {
  const container = document.getElementById("forecast");
  const weatherIcons = {
    "1":"‚òÄÔ∏è","2":"üå§Ô∏è","3":"‚õÖ","4":"üå•Ô∏è","5":"‚òÅÔ∏è","6":"üåßÔ∏è","7":"üå¶Ô∏è","8":"üå©Ô∏è","9":"üå®Ô∏è","10":"üå´Ô∏è",
    "11":"üå™Ô∏è","12":"üå¶Ô∏è","13":"üåßÔ∏è","14":"üå©Ô∏è","15":"üå®Ô∏è","16":"üå´Ô∏è"
  };

  try {
    const [portsalonRes, downingsRes] = await Promise.all([
      fetch("../../forecast_data/portsalon.json"),
      fetch("../../forecast_data/downings.json")
    ]);
    if (!portsalonRes.ok || !downingsRes.ok) throw new Error("Network response was not ok");
    const [portsalonData, downingsData] = await Promise.all([portsalonRes.json(), downingsRes.json()]);

    const schedule = [
      { date: "2025-08-28", startHour: 11, endHour: 19, location: "Portsalon", data: portsalonData },
      { date: "2025-08-29", startHour: 11, endHour: 19, location: "Downings", data: downingsData },
      { date: "2025-08-30", startHour: 11, endHour: 19, location: "Downings", data: downingsData },
      { date: "2025-08-31", startHour: 7,  endHour: 15, location: "Downings", data: downingsData }
    ];

    const grouped = {};

    for (const s of schedule) {
      let entries = s.data.filter(f => {
        const dt = new Date(f.time);
        const dateStr = dt.toISOString().split("T")[0];
        const hour = dt.getUTCHours();
        const localHour = (hour + 1) % 24;
        return dateStr === s.date && localHour >= s.startHour && localHour < s.endHour;
      }).map(f => ({ ...f, localHour: ((new Date(f.time)).getUTCHours() + 1) % 24 }));

      // Remove duplicates per hour, keep first non-null WeatherSymbol3
      const uniqueEntries = [];
      const seenHours = new Set();
      for (const f of entries) {
        const key = f.localHour;
        if (!seenHours.has(key)) {
          if (!f.WeatherSymbol3) f.WeatherSymbol3 = "1";
          uniqueEntries.push(f);
          seenHours.add(key);
        }
      }
      entries = uniqueEntries;

      if (entries.length > 0) grouped[s.date] = { location: s.location, entries };
    }

    if (Object.keys(grouped).length === 0) throw new Error("No matching forecasts for schedule");

    container.innerHTML = Object.entries(grouped).map(([date, group]) => {
      const cards = group.entries.map(f => {
        const timeStr = f.localHour.toString().padStart(2,"0") + ":00";
        const temp = f.Temperature ?? "N/A";
        const windKmh = f.WindSpeed ?? "N/A";
        const windDir = f.WindDirection ?? "?";
        const rain = f.Rainfall ?? "0";
        const icon = weatherIcons[f.WeatherSymbol3] || "‚ùì";
        return `
          <div class="card">
            <span class="icon">${icon}</span>
            <div class="time">${timeStr}</div>
            <div class="line">üå°Ô∏è Temp: ${temp} ¬∞C</div>
            <div class="line">üí® Wind: ${windKmh} km/h (${windDir}¬∞)</div>
            <div class="line">‚òî Rain: ${rain} mm</div>
          </div>
        `;
      }).join("");

      const dayStr = new Date(group.entries[0].time)
        .toLocaleDateString("en-GB",{weekday:"long", day:"numeric", month:"short"});

      return `<div class="day-group"><div class="day-title">${dayStr} ‚Äì ${group.location}</div><div class="forecast">${cards}</div></div>`;
    }).join("");

  } catch (err) {
    container.textContent = "Error loading forecast: " + err.message;
  }
}

loadForecast();
</script>
</body>
</html>
